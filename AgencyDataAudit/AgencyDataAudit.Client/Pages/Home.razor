@using System.Net.Http
@using System.Net.Http.Json
@using System.ComponentModel;
@using System.Globalization;

@page "/"

<PageTitle>Home</PageTitle>

@if (_series != null)
{
    <MudText Typo="Typo.h3" GutterBottom="true">Credova Metro 2 Trending</MudText>
    <MudText Typo="Typo.body1" Class="mb-8">From Last 12 Months</MudText>
    <MudPaper Class="doc-section-component-container">
        <MudChart ChartType="ChartType.Line" ChartSeries="@_series" @bind-SelectedIndex="_index" XAxisLabels="@_xAxisLabels" Width="@_width" Height="@_height" ChartOptions="@_options" AxisChartOptions="_axisChartOptions" />
    </MudPaper>
}

@code {
    private int _index = -1; //default value cannot be 0 -> first selectedindex is 0.
    private ChartOptions _options = new ChartOptions();
    private AxisChartOptions _axisChartOptions = new AxisChartOptions();
    private string _width = "975px";
    private string _height = "525px";
    private List<ChartSeries> _series = new List<ChartSeries>();
    private string[] _xAxisLabels = new string[12];
    private string? errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        HttpClient httpClient = new HttpClient();
        using var response = await httpClient.GetAsync("http://localhost:5127/Metro2/GetMetro2Trending/1");
        if (!response.IsSuccessStatusCode)
            {
                // set error message for display, log to console and return
                errorMessage = response.ReasonPhrase;
                Console.WriteLine($"There was an error! {errorMessage}");
                return;
            }

        var metro2Trending = await response.Content.ReadFromJsonAsync<Metro2Trending[]>();
        var recordCountData = new List<double>();
        var xAxisLabels = new List<string>(); 
        foreach (var m2t in metro2Trending)
        {
            recordCountData.Add((double)m2t.RecordCount);
            xAxisLabels.Add(m2t.ActivityDate);
        }
        var chartSeries = new ChartSeries() {
            Name = "Credova", Data = recordCountData.ToArray(), 
        };
        _series.Add(chartSeries);
        _xAxisLabels = xAxisLabels.ToArray();
    } 

    private class Metro2Trending
    {
        public string ActivityDate { get; set; }

        public long RecordCount { get; set; }
    }
}