@using System.Net.Http
@using System.Net.Http.Json
@using System.ComponentModel;
@using System.Globalization;

@page "/"

<PageTitle>Home</PageTitle>

@if (_series != null)
{
    <MudText Typo="Typo.h3" GutterBottom="true">Credova Dashboard</MudText>
    <MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="2" Class="pa-4" Style="height: 125px;">
                    <MudText Typo="Typo.h6" GutterBottom="true">Current Month's Record Count</MudText>
                    <MudText Typo="Typo.h4" GutterBottom="true">@currentMonthRecordCount</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="2" Class="pa-4" Style="height: 125px;">
                    <MudText Typo="Typo.h6" GutterBottom="true">Previous Month's Record Count</MudText>
                    <MudText Typo="Typo.h4" GutterBottom="true">@previousMonthRecordCount</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="12" md="4">
                <MudPaper Elevation="2" Class="pa-4" Style="height: 125px;">
                    <MudText Typo="Typo.h6" GutterBottom="true">Monthly Average</MudText>
                    <MudText Typo="Typo.h4" GutterBottom="true">@averageRecordCount</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="12" md="8">
                <MudPaper Elevation="2" Class="pa-4" Style="height: 575px;">
                    <MudChart ChartType="ChartType.Line" ChartSeries="@_series" @bind-SelectedIndex="_index" XAxisLabels="@_xAxisLabels" Width="@_width" Height="@_height" ChartOptions="@_options" AxisChartOptions="_axisChartOptions" />
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    private int _index = -1; //default value cannot be 0 -> first selectedindex is 0.
    private ChartOptions _options = new ChartOptions();
    private AxisChartOptions _axisChartOptions = new AxisChartOptions();
    private string _width = "950px";
    private string _height = "475px";
    private List<ChartSeries> _series = new List<ChartSeries>();
    private string[] _xAxisLabels = new string[12];
    private string? errorMessage;
    private long? currentMonthRecordCount;
    private long? previousMonthRecordCount;
    private double? averageRecordCount;

    
    protected override async Task OnInitializedAsync()
    {
        HttpClient httpClient = new HttpClient();
        using var response = await httpClient.GetAsync("http://localhost:5127/Metro2/GetMetro2Trending/1");
        if (!response.IsSuccessStatusCode)
            {
                // set error message for display, log to console and return
                errorMessage = response.ReasonPhrase;
                Console.WriteLine($"There was an error! {errorMessage}");
                return;
            }

        var metro2Trending = await response.Content.ReadFromJsonAsync<Metro2Trending[]>();
        if (metro2Trending == null)
            return;
        var recordCountData = new List<double>();
        var xAxisLabels = new List<string>(); 
        foreach (var m2t in metro2Trending)
        {
            recordCountData.Add((double)m2t.RecordCount);
            if (m2t.ActivityDate != null)
            {
                xAxisLabels.Add(m2t.ActivityDate);
            }
        }
        var chartSeries = new ChartSeries() {
            Name = "Credova", Data = recordCountData.ToArray(), 
        };
        _series.Add(chartSeries);
        _xAxisLabels = xAxisLabels.ToArray();
        currentMonthRecordCount = metro2Trending.Last().RecordCount;
        var previousMonth = metro2Trending.Reverse().Skip(1).Take(1).FirstOrDefault();
        previousMonthRecordCount = previousMonth?.RecordCount;
        averageRecordCount = Math.Round(metro2Trending.Select(m => m.RecordCount).Average(), 2);
    } 

    private class Metro2Trending
    {
        public string? ActivityDate { get; set; }

        public long RecordCount { get; set; }
    }
}