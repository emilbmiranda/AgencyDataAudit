@using System.Net.Http
@using System.Net.Http.Json
@using System.ComponentModel;
@using System.Globalization;
@using Microsoft.AspNetCore.Components.Forms

@page "/Errors"

<PageTitle>Errors</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Errors</MudText>
<MudText Typo="Typo.body1" Class="mb-8">Monthly errors from Consumer Reporting Agency data</MudText>

@if (reportingPeriods == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudSelect @bind-Value="selectedReportingPeriod" @bind-Value:after="GetErrorComparisonData" Label="Select Reporting Period" OpenIcon="@Icons.Material.Filled.CalendarMonth" AdornmentColor="Color.Secondary" FitContent="true">
        @foreach (ReportingPeriodData item in reportingPeriods) {
            <MudSelectItem Value="@item">@item.ActivityDate</MudSelectItem>
        }
    </MudSelect>
}

@if (errorComparisonData != null)
{
    <MudTable Items="errorComparisonData" Hover="true" SortLabel="Sort By" Elevation="0" AllowUnsorted="false">
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<ErrorComparisonData, object>(x=>x.ErrorCategoryName)">Error Category Name</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ErrorComparisonData, object>(x=>x.EquifaxRecordCount)">Equifax Record Count</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ErrorComparisonData, object>(x=>x.ExperianRecordCount)">Experian Record Count</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ErrorComparisonData, object>(x=>x.InnovisRecordCount)">Innovis Record Count</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ErrorComparisonData, object>(x=>x.TransUnionRecordCount)">TransUnion Record Count</MudTableSortLabel></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Error Category Name">@context.ErrorCategoryName</MudTd>
            <MudTd DataLabel="Equifax Record Count">@context.EquifaxRecordCount</MudTd>
            <MudTd DataLabel="Experian Record Count">@context.ExperianRecordCount</MudTd>
            <MudTd DataLabel="Innovis Record Count">@context.InnovisRecordCount</MudTd>
            <MudTd DataLabel="TransUnion Record Count">@context.TransUnionRecordCount</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[]{10, 20, 50, 100}" />
        </PagerContent>
    </MudTable>
}

@code {
    private ReportingPeriodData[]? reportingPeriods;
    private ReportingPeriodData? selectedReportingPeriod { get; set; }
    private ErrorComparisonData[]? errorComparisonData;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        HttpClient httpClient = new HttpClient();
        using var response = await httpClient.GetAsync("http://localhost:5127/ReportingPeriod/");
        if (!response.IsSuccessStatusCode)
            {
                // set error message for display, log to console and return
                errorMessage = response.ReasonPhrase;
                Console.WriteLine($"There was an error! {errorMessage}");
                return;
            }

        // convert http response data to UsersResponse object
        reportingPeriods = await response.Content.ReadFromJsonAsync<ReportingPeriodData[]>();
    } 

    protected async Task GetErrorComparisonData()
    {
        errorComparisonData = null;
        HttpClient httpClient = new HttpClient();
        using var response = await httpClient.GetAsync($"http://localhost:5127/Error/{selectedReportingPeriod?.ReportingPeriodId}");
        if (!response.IsSuccessStatusCode)
        {
            // set error message for display, log to console and return
            errorMessage = response.ReasonPhrase;
            Console.WriteLine($"There was an error! {errorMessage}");
            return;
        }

        errorComparisonData = await response.Content.ReadFromJsonAsync<ErrorComparisonData[]>();
    }

    private class ErrorComparisonData
    {
        public string ErrorCategoryName { get; set; }
        public long EquifaxRecordCount { get; set; }
        public long ExperianRecordCount { get; set; }
        public long InnovisRecordCount { get; set; }
        public long TransUnionRecordCount { get; set; }
    }

    static readonly bool _reportingPeriodConverterRegistered = RegisterReportingPeriodConverter();

    public static bool RegisterReportingPeriodConverter()
    {
        System.ComponentModel.TypeDescriptor.AddAttributes(
            typeof(ReportingPeriodData),
            new System.ComponentModel.TypeConverterAttribute(typeof(ReportingPeriodDataConverter))
        );
        return true;
    }

    public class ReportingPeriodDataConverter : System.ComponentModel.TypeConverter
    {
        public override bool CanConvertFrom(System.ComponentModel.ITypeDescriptorContext? context, System.Type sourceType)
            => sourceType == typeof(string) || base.CanConvertFrom(context, sourceType);

        public override object? ConvertFrom(System.ComponentModel.ITypeDescriptorContext? context, System.Globalization.CultureInfo? culture, object value)
        {
            if (value is string s)
                return new ReportingPeriodData { ActivityDate = s };
            return base.ConvertFrom(context, culture, value);
        }

        public override bool CanConvertTo(System.ComponentModel.ITypeDescriptorContext? context, System.Type? destinationType)
            => destinationType == typeof(string) || base.CanConvertTo(context, destinationType);

        public override object? ConvertTo(System.ComponentModel.ITypeDescriptorContext? context, System.Globalization.CultureInfo? culture, object value, System.Type destinationType)
        {
            if (destinationType == typeof(string) && value is ReportingPeriodData rp)
                return rp.ActivityDate;
            return base.ConvertTo(context, culture, value, destinationType);
        }
    }

    [TypeConverter(typeof(ReportingPeriodDataConverter))]
    private class ReportingPeriodData
    {
        public long ReportingPeriodId { get; set; }

        public long SystemOfRecordId { get; set; }

        public string ActivityDate { get; set; }
    }
}